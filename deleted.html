<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Deleted Voters</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue, remove, set } 
from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

document.addEventListener("DOMContentLoaded", () => {

  const app = initializeApp({
    apiKey: "AIzaSyCybmzCk3M8jV_255SbRGkGPWLAz2lgayE",
    authDomain: "bijus-app-52978.firebaseapp.com",
    databaseURL: "https://bijus-app-52978.firebaseio.com",
    projectId: "bijus-app-52978"
  });

  const db = getDatabase(app);

  const list = document.getElementById("deletedList");

  // ğŸ”¢ Counter elements
  const totalEl = document.getElementById("cTotal");
  const deadEl = document.getElementById("cDead");
  const shiftedEl = document.getElementById("cShifted");
  const dupEl = document.getElementById("cDuplicate");

  onValue(ref(db, "deleted_voters"), snap => {

    list.innerHTML = "";

    let total = 0, dead = 0, shifted = 0, duplicate = 0;

    const data = snap.val() || {};

    Object.entries(data).reverse().forEach(([key, v]) => {

      total++;

      if (v.deleteReason === "Dead") dead++;
      else if (v.deleteReason === "Shifted") shifted++;
      else if (v.deleteReason === "Duplicate") duplicate++;

      const div = document.createElement("div");
      div.style.cssText = `
        background:#fee2e2;
        border:1px solid #fecaca;
        padding:12px;
        border-radius:12px;
        margin-bottom:10px;
      `;

      div.innerHTML = `
        <div style="font-size:16px;font-weight:700;">
          ${v.name || "-"} <span>(#${v.serial || "-"})</span>
        </div>

        <div style="font-size:14px;margin-top:6px;">
          ğŸ  <b>House:</b> ${v.house?.replace("house_","")}<br>
          ğŸ†” <b>BYP:</b> ${v.byp || "-"}<br>
          ğŸ‚ <b>Age:</b> ${v.age || "-"}<br>
          ğŸš» <b>Gender:</b> ${v.gender || "-"}<br>
          âœ”ï¸ <b>Verified:</b> ${v.verified ? "Yes" : "No"}<br>
          ğŸ“ <b>Reason:</b>
          <span style="
            padding:2px 8px;
            border-radius:999px;
            font-weight:600;
            background:
              ${v.deleteReason === "Dead" ? "#fecaca" :
                v.deleteReason === "Shifted" ? "#dbeafe" :
                "#fde68a"};
          ">
            ${v.deleteReason || "â€”"}
          </span><br>
          â° <b>Deleted:</b> ${v.deletedAt}
        </div>

        <div style="margin-top:10px;display:flex;gap:10px;">
          <button class="restoreBtn"
            style="flex:1;padding:8px;border-radius:8px;border:1px solid #86efac;background:#dcfce7;font-weight:600;">
            â™»ï¸ Restore
          </button>

          <button class="permDeleteBtn"
            style="flex:1;padding:8px;border-radius:8px;border:1px solid #fecaca;background:#fee2e2;font-weight:600;">
            âŒ Permanent
          </button>
        </div>
      `;

      div.querySelector(".permDeleteBtn").onclick = async () => {
        const code = prompt("Enter secret code for PERMANENT delete:");
        if (!code || code.toLowerCase() !== "bijush") return alert("âŒ Wrong code");
        if (!confirm("âš ï¸ PERMANENT DELETE!\nThis cannot be undone.")) return;
        await remove(ref(db, `deleted_voters/${key}`));
      };

      div.querySelector(".restoreBtn").onclick = async () => {
        if (!confirm("Restore this voter?")) return;
        await set(ref(db, `voters/${v.house}/${v.originalKey || key}`), v);
        await remove(ref(db, `deleted_voters/${key}`));
      };

      list.appendChild(div);
    });

    // âœ… Update counters
    totalEl.textContent = total;
    deadEl.textContent = dead;
    shiftedEl.textContent = shifted;
    dupEl.textContent = duplicate;
  });

});
</script>
</head>

<body style="font-family:system-ui;background:#fef2f2;padding:15px;">

<h2 style="text-align:center;">ğŸ—‘ï¸ Deleted Voters</h2>

<!-- ğŸ”¢ SUMMARY BAR -->
<div style="
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:8px;
  margin-bottom:15px;
">
  <div style="background:#fee2e2;padding:10px;border-radius:10px;text-align:center;">
    ğŸ—‘ï¸ Total<br><b id="cTotal">0</b>
  </div>
  <div style="background:#fecaca;padding:10px;border-radius:10px;text-align:center;">
    âš°ï¸ Dead<br><b id="cDead">0</b>
  </div>
  <div style="background:#dbeafe;padding:10px;border-radius:10px;text-align:center;">
    ğŸšš Shifted<br><b id="cShifted">0</b>
  </div>
  <div style="background:#fde68a;padding:10px;border-radius:10px;text-align:center;">
    ğŸ“„ Duplicate<br><b id="cDuplicate">0</b>
  </div>
</div>

<button onclick="history.back()"
 style="margin-bottom:15px;padding:8px 14px;border-radius:8px;">
â¬… Back
</button>

<div id="deletedList"></div>

</body>
</html>